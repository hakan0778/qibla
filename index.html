<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Qibla</title>
  <style>
    :root{
      --bg:#050608;
      --card:rgba(10,12,16,.62);
      --card2:rgba(12,14,18,.55);
      --line:rgba(255,255,255,.10);

      --gold:#d6b25e;
      --gold2:#ffdd8a;
      --green:#22c55e;

      --text:#f3f4f6;
      --muted:rgba(243,244,246,.75);
      --warn:#fbbf24;
      --danger:#fb7185;
    }

    html, body { margin:0; height:100%; background:#000; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body { overflow:hidden; }

    /* Fullscreen map */
    #map{
      position:fixed; inset:0;
      background:#000;
    }

    /* Overlay UI */
    .ui{
      position:fixed; inset:0;
      padding: calc(12px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }

    .topCard{
      pointer-events:auto;
      max-width:520px;
      width:100%;
      margin:0 auto;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      border:1px solid rgba(214,178,94,.32);
      border-radius:16px;
      padding:12px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .version{
      font-weight:900;
      font-size:12px;
      letter-spacing:.7px;
      color:rgba(255,221,138,.92);
      text-transform:uppercase;
      opacity:.95;
    }
    .chip{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      font-weight:900;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .chip.ok{ color:#b7ffcf; border-color:rgba(34,197,94,.28); }
    .chip.bad{ color:rgba(255,155,178,.95); border-color:rgba(251,113,133,.35); }

    .btn{
      width:100%;
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(214,178,94,.35);
      background:linear-gradient(180deg, rgba(214,178,94,.35), rgba(255,221,138,.14));
      color:#fff;
      font-weight:950;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .btn:disabled{ opacity:.7; cursor:not-allowed; }

    .count{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(214,178,94,.22);
      background:rgba(0,0,0,.22);
      font-weight:950;
      color:rgba(255,221,138,.95);
      letter-spacing:.3px;
      text-align:center;
    }
    .count.show{ display:block; }

    .hint{
      margin-top:8px;
      font-size:12.5px;
      color:rgba(243,244,246,.78);
      line-height:1.35;
    }

    /* Bottom compass sheet */
    .sheet{
      pointer-events:auto;
      max-width:520px;
      width:100%;
      margin:0 auto;
      margin-top:auto;
      background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.30));
      border:1px solid rgba(214,178,94,.28);
      border-radius:18px;
      padding:12px;
      box-shadow:0 22px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .sheet:before{
      content:"";
      position:absolute; left:-20%; right:-20%; bottom:-24px; height:70px;
      background:
        radial-gradient(circle at 20% 30%, rgba(214,178,94,.20), transparent 55%),
        radial-gradient(circle at 80% 40%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(90deg, rgba(214,178,94,.20), rgba(255,221,138,.08), rgba(34,197,94,.10));
      transform:skewX(-10deg);
      opacity:.65;
      pointer-events:none;
    }

    .compassWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 0 6px;
      position:relative;
      z-index:1;
    }

    .ring{
      width:min(320px, 82vw);
      aspect-ratio:1/1;
      border-radius:50%;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 30%, rgba(214,178,94,.16), rgba(255,255,255,.03) 45%, rgba(0,0,0,.55));
      border:1px solid rgba(214,178,94,.35);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .ring:before{
      content:"";
      position:absolute; inset:10%;
      border-radius:50%;
      background:
        repeating-conic-gradient(
          from 0deg,
          rgba(214,178,94,.22) 0deg 1deg,
          transparent 1deg 10deg
        );
      opacity:.30;
      mask: radial-gradient(circle, transparent 0 62%, black 64% 100%);
      pointer-events:none;
    }

    .label{
      position:absolute;
      opacity:.85;
      font-weight:950;
      font-size:13px;
      letter-spacing:.8px;
      color:rgba(243,244,246,.78);
      text-shadow:0 4px 14px rgba(0,0,0,.6);
      user-select:none;
    }
    .n{ top:12px; color:rgba(255,221,138,.95); opacity:1; }
    .e{ right:16px; }
    .s{ bottom:12px; }
    .w{ left:16px; }

    .centerDot{
      position:absolute; left:50%; top:50%;
      width:10px; height:10px;
      transform:translate(-50%,-50%);
      border-radius:50%;
      background:radial-gradient(circle, rgba(255,221,138,1), rgba(214,178,94,.22));
      box-shadow:0 0 22px rgba(214,178,94,.55);
      z-index:6;
    }

    /* Rotating group (qibla direction) */
    .rot{
      position:absolute;
      left:50%; top:50%;
      width:0; height:0;
      transform:translate(-50%,-50%) rotate(0deg);
      transform-origin:50% 50%;
      transition:transform .14s ease-out;
      z-index:5;
    }

    /* Needle stem from center */
    .stem{
      position:absolute;
      left:50%; top:50%;
      width:10px;
      height:126px;
      transform:translate(-50%,-86%);
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,221,138,.95), rgba(214,178,94,.18));
      box-shadow:0 16px 25px rgba(0,0,0,.45);
    }
    .stem:after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-40px;
      width:8px;
      height:44px;
      transform:translateX(-50%);
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 18px rgba(0,0,0,.55);
    }

    /* Qibla arrow head at outer ring */
    .qHead{
      position:absolute;
      left:50%; top:50%;
      width:0; height:0;
      transform:translate(-50%,-166px);
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-bottom:34px solid rgba(34,197,94,.95);
      filter:drop-shadow(0 10px 14px rgba(0,0,0,.55));
    }
    .qHead:before{
      content:"";
      position:absolute;
      left:50%; top:2px;
      width:0; height:0;
      transform:translateX(-50%);
      border-left:18px solid transparent;
      border-right:18px solid transparent;
      border-bottom:38px solid rgba(214,178,94,.35);
      z-index:-1;
    }

    .kaaba{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-214px);
      font-size:18px;
      filter:drop-shadow(0 8px 12px rgba(0,0,0,.6));
      user-select:none;
    }

    /* Countdown overlay inside compass */
    .overlayCount{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(214,178,94,.22);
      background:rgba(0,0,0,.35);
      font-weight:950;
      color:rgba(255,221,138,.95);
      display:none;
      z-index:7;
      min-width:170px;
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .overlayCount.show{ display:block; }

    .info{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      z-index:1;
    }
    .txt{ font-size:14px; font-weight:950; letter-spacing:.2px; }
    .warn{ color:var(--warn); font-size:13px; line-height:1.35; }
    .okmsg{ color:#b7ffcf; font-size:13px; font-weight:850; }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(90px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(34,197,94,.28);
      color:#b7ffcf;
      padding:10px 12px;
      border-radius:14px;
      font-weight:950;
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      pointer-events:none;
      z-index:999;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="ui">
    <div class="topCard">
      <div class="row">
        <div class="version">SÃ¼rÃ¼m: MAPS-01</div>
        <div id="chip" class="chip">Bekliyorâ€¦</div>
      </div>

      <button id="startBtn" class="btn">BaÅŸlat (SensÃ¶r izni)</button>

      <div id="countdownTop" class="count">YÃ¶n belirleniyorâ€¦ 5</div>

      <div class="hint">
        iPhoneâ€™da pusula sensÃ¶rÃ¼ sadece <b>butona bastÄ±ktan sonra</b> aÃ§Ä±lÄ±r.
        Harita iÃ§in konum izni de gerekebilir.
      </div>
    </div>

    <div class="sheet">
      <div class="compassWrap">
        <div class="ring">
          <div class="label n">N</div><div class="label e">E</div><div class="label s">S</div><div class="label w">W</div>
          <div class="centerDot"></div>

          <div id="overlayCount" class="overlayCount">YÃ¶n belirleniyorâ€¦ 5</div>

          <div id="rot" class="rot">
            <div class="stem"></div>
            <div class="qHead"></div>
            <div class="kaaba">ðŸ•‹</div>
          </div>
        </div>
      </div>

      <div class="info">
        <div id="bearingTxt" class="txt">KÄ±ble: --Â°</div>
        <div id="warn" class="warn"></div>
        <div class="okmsg">Ä°pucu: En doÄŸru Ã¶lÃ§Ã¼m iÃ§in telefonu dÃ¼z tut, metal/mÄ±knatÄ±s etkisi yapabilecek ÅŸeylerden uzak dur.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">KÄ±ble yÃ¶nÃ¼ bulundu! âœ…</div>

  <!-- Google Maps: BURADA KEY'Ä° YAZ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDF6r7xLgQEip2Kkn0gAGqvOJBbjTOml8&v=weekly"></script>

  <script>
    // ====== Kaaba ======
    const KAABA_LATLNG = { lat: 21.4225, lng: 39.8262 };

    // ====== UI refs ======
    const chip = document.getElementById('chip');
    const startBtn = document.getElementById('startBtn');
    const warnEl = document.getElementById('warn');
    const bearingTxt = document.getElementById('bearingTxt');
    const rot = document.getElementById('rot');

    const countdownTop = document.getElementById('countdownTop');
    const overlayCount = document.getElementById('overlayCount');
    const toast = document.getElementById('toast');

    // ====== State ======
    let map, userMarker, kaabaMarker, line;
    let userLatLng = null;
    let qiblaBearing = null;

    let compassStarted = false;
    let gotFirstHeading = false;
    let smooth = 0;

    let countdownTimer = null;
    let countdownValue = 0;

    function setChip(text, mode='normal'){
      chip.textContent = text;
      chip.classList.remove('ok','bad');
      if (mode === 'ok') chip.classList.add('ok');
      if (mode === 'bad') chip.classList.add('bad');
    }

    function showToastOnce(){
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2200);
    }

    function showCountdown(){
      clearInterval(countdownTimer);
      countdownValue = 5;

      countdownTop.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;
      overlayCount.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;

      countdownTop.classList.add('show');
      overlayCount.classList.add('show');

      countdownTimer = setInterval(() => {
        countdownValue -= 1;
        if (countdownValue <= 0){
          clearInterval(countdownTimer);
          countdownTop.textContent = 'YÃ¶n belirleniyorâ€¦';
          overlayCount.textContent = 'YÃ¶n belirleniyorâ€¦';
          return;
        }
        countdownTop.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;
        overlayCount.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;
      }, 1000);
    }

    function hideCountdown(){
      clearInterval(countdownTimer);
      countdownTop.classList.remove('show');
      overlayCount.classList.remove('show');
    }

    // ====== Math: bearing to Kaaba ======
    function bearingToKaaba(lat, lng) {
      const Ï†1 = lat * Math.PI/180;
      const Î»1 = lng * Math.PI/180;
      const Ï†2 = KAABA_LATLNG.lat * Math.PI/180;
      const Î»2 = KAABA_LATLNG.lng * Math.PI/180;

      const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2 - Î»1);
      let Î¸ = Math.atan2(y, x) * 180/Math.PI;
      return (Î¸ + 360) % 360;
    }

    // ====== Smooth rotation ======
    function setRotation(deg) {
      smooth = smooth + 0.18 * (deg - smooth);
      rot.style.transform = `translate(-50%,-50%) rotate(${smooth}deg)`;
    }

    // ====== Compass handler ======
    function getHeadingFromEvent(e){
      // iOS Safari provides webkitCompassHeading (best)
      if (typeof e.webkitCompassHeading === 'number') return e.webkitCompassHeading;
      // Other browsers: alpha is 0..360 (needs invert)
      if (typeof e.alpha === 'number') return (360 - e.alpha);
      return null;
    }

    function handleOrientation(e) {
      if (qiblaBearing == null) return;

      const heading = getHeadingFromEvent(e);
      if (heading == null) return;

      const rotateDeg = (qiblaBearing - heading + 360) % 360;
      setRotation(rotateDeg);

      if (!gotFirstHeading){
        gotFirstHeading = true;
        hideCountdown();
        setChip('Pusula Ã§alÄ±ÅŸÄ±yor âœ…', 'ok');
        warnEl.textContent = '';
        showToastOnce();
      }
    }

    // ====== Location ======
    function updateQiblaFromLocation(latlng){
      userLatLng = latlng;
      qiblaBearing = bearingToKaaba(latlng.lat, latlng.lng);
      bearingTxt.textContent = `KÄ±ble: ${Math.round(qiblaBearing)}Â°`;

      // Map updates
      if (map){
        if (!userMarker){
          userMarker = new google.maps.Marker({
            position: userLatLng,
            map,
            title: 'Sen',
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 7,
              fillColor: '#22c55e',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });
        } else {
          userMarker.setPosition(userLatLng);
        }

        if (!kaabaMarker){
          kaabaMarker = new google.maps.Marker({
            position: KAABA_LATLNG,
            map,
            title: 'KÃ¢be ðŸ•‹'
          });
        }

        if (!line){
          line = new google.maps.Polyline({
            map,
            path: [userLatLng, KAABA_LATLNG],
            geodesic: true,
            strokeColor: '#22c55e',
            strokeOpacity: 0.95,
            strokeWeight: 4
          });
        } else {
          line.setPath([userLatLng, KAABA_LATLNG]);
        }
      }

      if (compassStarted){
        showCountdown();
        warnEl.textContent = 'YÃ¶n belirleniyorâ€¦';
        setChip('Konum hazÄ±r âœ…', 'ok');
      } else {
        warnEl.textContent = 'Åžimdi â€œBaÅŸlat (SensÃ¶r izni)â€ butonuna bas.';
        setChip('Konum hazÄ±r âœ…', 'ok');
      }
    }

    function requestLocation(){
      if (!navigator.geolocation){
        warnEl.textContent = 'Bu cihaz konum desteklemiyor.';
        setChip('Konum yok', 'bad');
        return;
      }

      warnEl.textContent = 'Konum alÄ±nÄ±yorâ€¦';
      setChip('Konum alÄ±nÄ±yorâ€¦');

      // Watch gives better stability for map/line
      navigator.geolocation.watchPosition(
        (pos) => {
          const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          updateQiblaFromLocation(latlng);

          // Center map first time
          if (map && map.__centered !== true){
            map.setCenter(latlng);
            map.setZoom(16);
            map.__centered = true;
          }
        },
        () => {
          warnEl.textContent = 'Konum izni ver. (iPhone: Ayarlar > Gizlilik ve GÃ¼venlik > Konum Servisleri)';
          setChip('Konum izni yok', 'bad');
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge: 2000 }
      );
    }

    // ====== Google Map init ======
    function initMap(){
      try{
        map = new google.maps.Map(document.getElementById('map'), {
          center: KAABA_LATLNG,
          zoom: 3,
          mapTypeId: 'satellite',
          disableDefaultUI: true,
          clickableIcons: false,
          gestureHandling: 'greedy'
        });
      } catch (e){
        // If Maps key is wrong or blocked, show a clear message
        warnEl.textContent = 'Harita aÃ§Ä±lmadÄ±. API key veya kÄ±sÄ±tlar kontrol edilmeli.';
        setChip('Harita yok', 'bad');
      }
    }

    // ====== Start button ======
    async function startCompass(){
      gotFirstHeading = false;
      compassStarted = false;

      setChip('Ä°zin isteniyorâ€¦');
      showCountdown();

      // iOS permission gate
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const p = await DeviceOrientationEvent.requestPermission();
          if (p !== 'granted') {
            hideCountdown();
            warnEl.textContent = 'Pusula izni verilmedi. iPhone: Ayarlar > Safari > Hareket ve YÃ¶n EriÅŸimi aÃ§Ä±k olmalÄ±.';
            setChip('Ä°zin yok', 'bad');
            return;
          }
        } catch {
          hideCountdown();
          warnEl.textContent = 'Pusula izni alÄ±namadÄ±. Safari sensÃ¶r eriÅŸimi kapalÄ± olabilir.';
          setChip('Ä°zin yok', 'bad');
          return;
        }
      }

      window.addEventListener('deviceorientation', handleOrientation, true);
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);

      compassStarted = true;
      startBtn.disabled = true;
      startBtn.textContent = 'SensÃ¶r AÃ§Ä±k âœ…';

      // If location not ready yet:
      if (qiblaBearing == null){
        warnEl.textContent = 'Konum izni gerekli. LÃ¼tfen konum izni ver.';
        setChip('Konum bekleniyorâ€¦');
        requestLocation(); // try again after user gesture
      } else {
        warnEl.textContent = 'YÃ¶n belirleniyorâ€¦';
        setChip('BaÅŸlatÄ±ldÄ±â€¦');
      }
    }

    // ====== Boot ======
    startBtn.addEventListener('click', startCompass);

    // Map first, then location
    initMap();
    requestLocation();
  </script>
</body>
</html>
