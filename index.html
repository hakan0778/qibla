<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KÄ±ble (Konum â†’ KÃ¢be) | Uydu + YeÅŸil Onay</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    #panel{
      position: fixed; left: 12px; top: 12px; z-index: 10;
      background: rgba(255,255,255,.95); padding: 10px 12px;
      border-radius: 12px; font-family: system-ui, Arial; font-size: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      max-width: 360px;
    }
    #status { margin-top: 8px; font-size: 12px; opacity: .9; white-space: pre-line; line-height: 1.35; }
    .row { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      padding: 9px 10px; border: 0; border-radius: 10px; cursor: pointer;
      background:#111; color:#fff; font-weight:600;
    }
    button.secondary { background:#e9e9e9; color:#111; font-weight:600; }
    button:active { transform: scale(0.98); }

    /* Ä°lk aÃ§Ä±lÄ±ÅŸ â€œBaÅŸlatâ€ katmanÄ± (iOS motion izni iÃ§in ÅŸart olabilir) */
    #startOverlay{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center; justify-content: center;
      padding: 20px;
    }
    #startCard{
      width: min(420px, 92vw);
      background: #fff; border-radius: 16px;
      padding: 16px;
      font-family: system-ui, Arial;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    #startCard h3{ margin: 0 0 8px; font-size: 16px; }
    #startCard p{ margin: 0 0 12px; font-size: 13px; opacity: .85; line-height:1.35; }
    #startCard .btnWide{ width:100%; padding: 12px; border-radius: 12px; }
  </style>
</head>

<body>
  <div id="panel">
    <div><b>KÄ±ble</b> (Konum â†’ KÃ¢be)</div>

    <div class="row">
      <button id="btnMyLoc" class="secondary">ğŸ“ Konumuma Git</button>
      <button id="btnToggle" class="secondary">ğŸ›° Uydu / Harita</button>
    </div>

    <div id="status">HazÄ±r. Konum alÄ±nÄ±yorâ€¦</div>
  </div>

  <div id="map"></div>

  <!-- iOS/Android iÃ§in â€œtek dokunuÅŸla baÅŸlatâ€ -->
  <div id="startOverlay">
    <div id="startCard">
      <h3>Ä°zinler gerekli</h3>
      <p>
        Konum ve (varsa) cihaz yÃ¶nÃ¼ izniyle kÄ±ble doÄŸruluÄŸu artar.
        Tek dokunuÅŸla baÅŸlat.
      </p>
      <button id="btnStart" class="btnWide">BaÅŸlat (Konum + YÃ¶n)</button>
    </div>
  </div>

  <script>
    /************ AYARLAR ************/
    const KAABA = { lat: 21.422487, lng: 39.826206 };
    const CLOSE_ZOOM = 17;         // aÃ§Ä±lÄ±ÅŸta konuma yakÄ±nlaÅŸma
    const ALIGN_TOL_DEG = 7;       // telefon Ã¼stÃ¼ kÄ±bleye gelince â€œyeÅŸilâ€ eÅŸiÄŸi (Â±7Â°)
    const LINE_RED = "#111";       // normal Ã§izgi
    const LINE_GREEN = "#19a84a";  // doÄŸru yÃ¶n Ã§izgisi

    /************ DURUM ************/
    let map, userMarker, kaabaMarker, qiblaLine;
    let mapIsSatellite = true;

    let userPos = null;
    let qiblaDeg = null;
    let headingDeg = null;
    let haveMotion = false;

    function setStatus(t){ document.getElementById("status").textContent = t; }
    function normalize360(x){ return (x % 360 + 360) % 360; }
    function toRad(d){ return d * Math.PI / 180; }
    function toDeg(r){ return r * 180 / Math.PI; }
    function angleDelta(a, b){
      // smallest difference between two angles 0..360
      let d = normalize360(a - b);
      if (d > 180) d = 360 - d;
      return d; // 0..180
    }

    function bearingToKaaba(lat, lng){
      const Ï†1 = toRad(lat);
      const Ï†2 = toRad(KAABA.lat);
      const Î”Î» = toRad(KAABA.lng - lng);
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      const Î¸ = Math.atan2(y, x);
      return (toDeg(Î¸) + 360) % 360;
    }

    /************ HARÄ°TA ************/
    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.8, lng: 31.4 }, // ilk aÃ§Ä±lÄ±ÅŸta yaklaÅŸÄ±k
        zoom: 6,
        mapTypeId: "satellite",   // 3) hep uydu aÃ§Ä±lsÄ±n
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
      });

      kaabaMarker = new google.maps.Marker({
        position: KAABA, map, title: "KÃ¢be",
      });

      // 1) uygulamayÄ± aÃ§Ä±nca hemen konumu yakÄ±n plan gÃ¶ster (izin verilirse)
      // iOS Motion iÃ§in tek dokunuÅŸ gerekebilir; konumu yine de hemen istemeye Ã§alÄ±ÅŸÄ±yoruz.
      autoStart();
    }
    window.initMap = initMap;

    function ensureUserMarker(){
      if (!userPos) return;
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          position: userPos,
          map,
          title: "Konumum",
        });
      } else {
        userMarker.setPosition(userPos);
      }
    }

    function ensureLine(){
      if (!userPos) return;

      if (qiblaLine) qiblaLine.setMap(null);

      qiblaLine = new google.maps.Polyline({
        path: [userPos, KAABA],
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 5,
        strokeColor: LINE_RED
      });
      qiblaLine.setMap(map);
    }

    function zoomToUser(){
      if (!userPos || !map) return;
      map.setCenter(userPos);
      map.setZoom(CLOSE_ZOOM);
    }

    function updateLineColor(){
      if (!qiblaLine || qiblaDeg == null) return;

      // 2) Telefonun Ã¼stÃ¼ kÄ±bleyi gÃ¶sterince Ã§izgi yeÅŸil olsun
      // heading yoksa (sensÃ¶r yok/izin yok) Ã§izgi normal kalsÄ±n
      let ok = false;

      if (haveMotion && headingDeg != null) {
        const d = angleDelta(qiblaDeg, headingDeg);
        ok = d <= ALIGN_TOL_DEG;
      }

      qiblaLine.setOptions({ strokeColor: ok ? LINE_GREEN : LINE_RED });

      const parts = [];
      if (userPos) parts.push(`Konum: ${userPos.lat.toFixed(5)}, ${userPos.lng.toFixed(5)}`);
      if (qiblaDeg != null) parts.push(`KÄ±ble: ${qiblaDeg.toFixed(1)}Â°`);
      if (haveMotion && headingDeg != null) {
        const d = angleDelta(qiblaDeg, headingDeg);
        parts.push(`Telefon yÃ¶nÃ¼: ${headingDeg.toFixed(1)}Â°`);
        parts.push(`Fark: ${d.toFixed(1)}Â°  (â‰¤ ${ALIGN_TOL_DEG}Â° olunca YEÅÄ°L)`);
      } else {
        parts.push(`YÃ¶n sensÃ¶rÃ¼: kapalÄ± / yok (Ã§izgi sabit kalÄ±r)`);
      }
      setStatus(parts.join("\n"));
    }

    /************ KONUM ************/
    async function getLocationOnce(){
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation desteklenmiyor."));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    async function startLocation(){
      setStatus("Konum alÄ±nÄ±yor...");
      userPos = await getLocationOnce();
      qiblaDeg = bearingToKaaba(userPos.lat, userPos.lng);

      ensureUserMarker();
      ensureLine();
      zoomToUser();
      updateLineColor();
    }

    /************ YÃ–N (PUSULA) ************/
    async function requestMotionIfNeeded(){
      // iOS: mutlaka kullanÄ±cÄ± dokunuÅŸuyla Ã§aÄŸrÄ±lmalÄ±
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") throw new Error("YÃ¶n izni verilmedi.");
      }
      haveMotion = true;
    }

    function startMotionListeners(){
      window.addEventListener("deviceorientationabsolute", onOrientation, true);
      window.addEventListener("deviceorientation", onOrientation, true);
    }

    function onOrientation(e){
      let h = null;

      // iOS Safari (en gÃ¼venilir)
      if (typeof e.webkitCompassHeading === "number") {
        h = e.webkitCompassHeading;
      }
      // Android Chrome (Ã§oÄŸunluk)
      else if (typeof e.alpha === "number") {
        h = 360 - e.alpha;
      }

      if (h == null) return;
      headingDeg = normalize360(h);
      updateLineColor();
    }

    /************ BAÅLATMA (tek seferde) ************/
    function showStartOverlay(show){
      document.getElementById("startOverlay").style.display = show ? "flex" : "none";
    }

    async function autoStart(){
      // Konumu aÃ§Ä±lÄ±ÅŸta istemeye Ã§alÄ±ÅŸ
      try {
        await startLocation();
      } catch (e) {
        setStatus("Konum izni gerekli. BaÅŸlat'a bas.");
        showStartOverlay(true);
        return;
      }

      // Motion (yÃ¶n) iÃ§in iOSâ€™ta dokunuÅŸ gerekebilir.
      // Androidâ€™de Ã§oÄŸu zaman otomatik Ã§alÄ±ÅŸÄ±r.
      try {
        // iOS ise dokunuÅŸ isteyecek; burada hata verebilir â†’ overlay aÃ§arÄ±z
        await requestMotionIfNeeded();
        startMotionListeners();
        updateLineColor();
      } catch (e) {
        // YÃ¶n izni iÃ§in overlay
        showStartOverlay(true);
      }
    }

    async function startAllWithUserGesture(){
      // 5) â€œilk aÃ§Ä±lÄ±ÅŸta izinleri sorâ€ yaklaÅŸÄ±mÄ±nÄ±n webâ€™deki en garantili hali:
      // tek butona basÄ±nca hem konumu hem yÃ¶nÃ¼ istemek.
      showStartOverlay(false);

      try {
        await startLocation();
      } catch (e) {
        setStatus("Konum alÄ±namadÄ±: " + (e.message || "Hata"));
        showStartOverlay(true);
        return;
      }

      try {
        await requestMotionIfNeeded();
        startMotionListeners();
        updateLineColor();
      } catch (e) {
        // yÃ¶n olmadan da
