<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qibla</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .wrap { height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; font-family:system-ui; padding:16px; box-sizing:border-box; }

    /* START BUTTON */
    .topbar { width:100%; max-width:420px; display:flex; flex-direction:column; gap:10px; margin-bottom:14px; }
    .btn {
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:0;
      background:#3b82f6;
      color:#fff;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }

    .ring { width:min(280px, 80vw); aspect-ratio:1/1; border:2px solid #a85a1a; border-radius:50%; position:relative; display:flex; align-items:center; justify-content:center; }
    .label { position:absolute; opacity:.7; font-weight:600; font-size:14px; }
    .n { top:10px; color:#ff7a18; opacity:1; } .e { right:14px; } .s { bottom:10px; } .w { left:14px; }
    .center { width:6px; height:6px; background:#ff7a18; border-radius:50%; position:absolute; }
    .arrow { width:6px; height:110px; background:#ff7a18; border-radius:6px; transform-origin:50% 90%; transition:transform .18s ease-out; }
    .kaaba { position:absolute; transform:translateY(-120px); font-size:18px; }
    .txt { margin-top:14px; opacity:.9; font-size:14px; }
    .warn { color:#ffcc66; margin-top:10px; font-size:14px; text-align:center; max-width:420px; }
    .mini { opacity:.75; font-size:12px; line-height:1.35; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- TOP BAR / START BUTTON -->
    <div class="topbar">
      <button id="startBtn" class="btn">BaÅŸlat (SensÃ¶r Ä°zni)</button>
      <div class="mini">
        iPhoneâ€™da pusula iÃ§in izin, sadece bu butona bastÄ±ktan sonra Ã§alÄ±ÅŸÄ±r.
      </div>
    </div>

    <div class="ring">
      <div class="label n">N</div><div class="label e">E</div><div class="label s">S</div><div class="label w">W</div>
      <div class="center"></div>
      <div id="arrow" class="arrow"></div>
      <div id="kaaba" class="kaaba">ðŸ•‹</div>
    </div>

    <div id="bearingTxt" class="txt">KÄ±ble: --Â°</div>
    <div id="warn" class="warn"></div>
  </div>

<script>
  const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 };
  const warn = document.getElementById('warn');
  const bearingTxt = document.getElementById('bearingTxt');
  const arrow = document.getElementById('arrow');
  const kaaba = document.getElementById('kaaba');
  const startBtn = document.getElementById('startBtn');

  let qiblaBearing = null;
  let compassStarted = false;

  function bearingToKaaba(lat, lon) {
    const Ï†1 = lat * Math.PI/180, Î»1 = lon * Math.PI/180;
    const y = Math.sin(KAABA.lon - Î»1) * Math.cos(KAABA.lat);
    const x = Math.cos(Ï†1)*Math.sin(KAABA.lat) - Math.sin(Ï†1)*Math.cos(KAABA.lat)*Math.cos(KAABA.lon - Î»1);
    let Î¸ = Math.atan2(y, x) * 180/Math.PI;
    return (Î¸ + 360) % 360;
  }

  // --- LOCATION ---
  function requestLocation() {
    warn.textContent = 'Konum isteniyor...';
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        qiblaBearing = bearingToKaaba(pos.coords.latitude, pos.coords.longitude);
        bearingTxt.textContent = `KÄ±ble: ${Math.round(qiblaBearing)}Â°`;
        warn.textContent = compassStarted ? '' : 'Åžimdi â€œBaÅŸlat (SensÃ¶r Ä°zni)â€ butonuna basÄ±n.';
      },
      () => {
        warn.textContent = 'Konum izni verin (Safari: Ayarlar > Gizlilik > Konum).';
      },
      { enableHighAccuracy:true, timeout:10000 }
    );
  }

  // --- SMOOTH ROTATION ---
  let smooth = 0;
  function setRotation(deg) {
    smooth = smooth + 0.18 * (deg - smooth);
    arrow.style.transform = `rotate(${smooth}deg)`;
    kaaba.style.transform = `translateY(-120px) rotate(${smooth}deg)`;
  }

  function handleOrientation(e) {
    if (qiblaBearing == null) return;

    let heading = null;

    // iOS Safari: the best source
    if (typeof e.webkitCompassHeading === 'number') {
      heading = e.webkitCompassHeading;
    } else if (typeof e.alpha === 'number') {
      // fallback
      heading = 360 - e.alpha;
    }

    if (heading == null) return;

    const rotateDeg = (qiblaBearing - heading + 360) % 360;
    setRotation(rotateDeg);
  }

  // --- COMPASS INIT (MUST BE ON USER CLICK FOR iOS) ---
  async function startCompass() {
    compassStarted = false;

    // iOS 13+ permission gate
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const p = await DeviceOrientationEvent.requestPermission();
        if (p !== 'granted') {
          warn.textContent = 'Pusula izni verilmedi. iPhone: Ayarlar > Safari > Hareket ve YÃ¶n EriÅŸimi aÃ§Ä±k olmalÄ±.';
          return;
        }
      } catch (err) {
        warn.textContent = 'Pusula izni alÄ±namadÄ±. Safari sensÃ¶r eriÅŸimi kapalÄ± olabilir.';
        return;
      }
    }

    // start listening
    window.addEventListener('deviceorientation', handleOrientation, true);
    compassStarted = true;

    // UI
    startBtn.disabled = true;
    startBtn.textContent = 'SensÃ¶r AÃ§Ä±k âœ…';
    warn.textContent = (qiblaBearing == null)
      ? 'Konum izni gerekli. LÃ¼tfen konum izni verin.'
      : '';
  }

  // Button click is the key on iPhone
  startBtn.addEventListener('click', startCompass);

  // Start by requesting location (can be requested without button)
  requestLocation();
</script>
</body>
</html>
