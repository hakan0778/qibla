<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Qibla</title>
  <style>
    :root{
      --bg:#050608;
      --card:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);

      --gold:#d6b25e;
      --gold2:#ffdd8a;
      --green:#22c55e;

      --text:#f3f4f6;
      --muted:rgba(243,244,246,.72);
      --warn:#fbbf24;
    }

    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body { overflow:hidden; }

    /* Subtle background texture */
    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 20% 10%, rgba(214,178,94,.18), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(34,197,94,.10), transparent 45%),
        radial-gradient(circle at 50% 80%, rgba(214,178,94,.10), transparent 55%),
        repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 1px, transparent 1px 10px);
      opacity:.35;
      pointer-events:none;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(12px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      gap:12px;
      max-width:520px;
      margin:0 auto;
      position:relative;
      z-index:1;
    }

    .top{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(214,178,94,.25);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .btn{
      flex:1;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(214,178,94,.35);
      background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,221,138,.10));
      color:#fff;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .btn:disabled{ opacity:.7; cursor:not-allowed; }

    .chip{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      font-weight:900;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .chip.ok{ color:#b7ffcf; border-color:rgba(34,197,94,.28); }

    .hint{ font-size:12.5px; color:var(--muted); line-height:1.35; }

    /* Countdown pill */
    .count{
      display:none;
      margin-top:2px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(214,178,94,.22);
      background:rgba(0,0,0,.22);
      font-weight:900;
      color:rgba(255,221,138,.95);
      letter-spacing:.3px;
      text-align:center;
    }
    .count.show{ display:block; }

    .mid{ flex:1; display:flex; align-items:center; justify-content:center; min-height:0; }

    .ring{
      width:min(340px, 86vw);
      aspect-ratio:1/1;
      border-radius:50%;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 30%, rgba(214,178,94,.18), rgba(255,255,255,.03) 45%, rgba(0,0,0,.50));
      border:1px solid rgba(214,178,94,.35);
      box-shadow: 0 25px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .ring:before{
      content:"";
      position:absolute; inset:10%;
      border-radius:50%;
      background:
        repeating-conic-gradient(
          from 0deg,
          rgba(214,178,94,.22) 0deg 1deg,
          transparent 1deg 8deg
        );
      opacity:.35;
      mask: radial-gradient(circle, transparent 0 60%, black 62% 100%);
      pointer-events:none;
    }

    .label{
      position:absolute;
      opacity:.80;
      font-weight:900;
      font-size:13px;
      letter-spacing:.6px;
      color:rgba(243,244,246,.78);
      text-shadow:0 4px 14px rgba(0,0,0,.6);
      user-select:none;
    }
    .n{ top:12px; color:rgba(255,221,138,.95); opacity:1; }
    .e{ right:16px; }
    .s{ bottom:12px; }
    .w{ left:16px; }

    .centerDot{
      position:absolute; left:50%; top:50%;
      width:10px; height:10px;
      transform:translate(-50%,-50%);
      border-radius:50%;
      background:radial-gradient(circle, rgba(255,221,138,1), rgba(214,178,94,.25));
      box-shadow:0 0 22px rgba(214,178,94,.55);
      z-index:6;
    }

    .rot{
      position:absolute;
      left:50%; top:50%;
      width:0; height:0;
      transform:translate(-50%,-50%) rotate(0deg);
      transform-origin:50% 50%;
      transition:transform .16s ease-out;
      z-index:5;
    }

    .needle{
      position:absolute;
      left:50%; top:50%;
      width:10px;
      height:132px;
      transform:translate(-50%,-84%);
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,221,138,.95), rgba(214,178,94,.25));
      box-shadow:0 16px 25px rgba(0,0,0,.45);
    }
    .needle:after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-42px;
      width:8px;
      height:46px;
      transform:translateX(-50%);
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 18px rgba(0,0,0,.55);
    }

    .qHead{
      position:absolute;
      left:50%; top:50%;
      width:0; height:0;
      transform:translate(-50%,-165px);
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-bottom:34px solid rgba(34,197,94,.95);
      filter:drop-shadow(0 10px 14px rgba(0,0,0,.55));
    }
    .qHead:before{
      content:"";
      position:absolute;
      left:50%; top:2px;
      width:0; height:0;
      transform:translateX(-50%);
      border-left:18px solid transparent;
      border-right:18px solid transparent;
      border-bottom:38px solid rgba(214,178,94,.35);
      z-index:-1;
    }

    .kaaba{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-212px);
      font-size:18px;
      filter:drop-shadow(0 8px 12px rgba(0,0,0,.6));
      user-select:none;
    }

    .bottom{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(214,178,94,.25);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    /* Decorative bottom stripe */
    .bottom:before{
      content:"";
      position:absolute; left:-20%; right:-20%; bottom:-22px; height:70px;
      background:
        radial-gradient(circle at 20% 30%, rgba(214,178,94,.25), transparent 55%),
        radial-gradient(circle at 80% 40%, rgba(34,197,94,.18), transparent 60%),
        linear-gradient(90deg, rgba(214,178,94,.22), rgba(255,221,138,.10), rgba(34,197,94,.12));
      transform:skewX(-10deg);
      opacity:.55;
      pointer-events:none;
    }

    .txt{ font-size:14px; font-weight:900; letter-spacing:.2px; position:relative; z-index:1; }
    .warn{ color:var(--warn); font-size:13px; line-height:1.35; position:relative; z-index:1; }
    .hint2{ font-size:12.5px; color:var(--muted); line-height:1.35; position:relative; z-index:1; }
  </style>
</head>

<body>
  <div class="app">

    <div class="top">
      <div class="row">
        <button id="startBtn" class="btn">BaÅŸlat (SensÃ¶r Ä°zni)</button>
        <div id="stateChip" class="chip">Bekliyorâ€¦</div>
      </div>
      <div id="countdown" class="count">YÃ¶n belirleniyorâ€¦ 5</div>
      <div class="hint">
        iPhoneâ€™da pusula sensÃ¶rÃ¼ sadece <b>butona bastÄ±ktan sonra</b> aÃ§Ä±lÄ±r.
      </div>
    </div>

    <div class="mid">
      <div class="ring">
        <div class="label n">N</div><div class="label e">E</div><div class="label s">S</div><div class="label w">W</div>

        <div class="centerDot"></div>

        <div id="rot" class="rot">
          <div class="needle"></div>
          <div class="qHead"></div>
          <div class="kaaba">ðŸ•‹</div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <div id="bearingTxt" class="txt">KÄ±ble: --Â°</div>
      <div id="warn" class="warn"></div>
      <div class="hint2">Ä°pucu: En doÄŸru Ã¶lÃ§Ã¼m iÃ§in telefonu dÃ¼z tut, metal/ mÄ±knatÄ±s etkisi yapabilecek ÅŸeylerden uzak dur.</div>
    </div>

  </div>

<script>
  const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 };
  const warn = document.getElementById('warn');
  const bearingTxt = document.getElementById('bearingTxt');
  const rot = document.getElementById('rot');
  const startBtn = document.getElementById('startBtn');
  const stateChip = document.getElementById('stateChip');
  const countdownEl = document.getElementById('countdown');

  let qiblaBearing = null;
  let compassStarted = false;

  // countdown state
  let countdownTimer = null;
  let countdownValue = 0;

  function setState(t, ok=false){
    stateChip.textContent = t;
    stateChip.classList.toggle('ok', ok);
  }

  function showCountdown(){
    // Start from 5
    clearInterval(countdownTimer);
    countdownValue = 5;
    countdownEl.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;
    countdownEl.classList.add('show');

    countdownTimer = setInterval(() => {
      countdownValue -= 1;
      if (countdownValue <= 0){
        clearInterval(countdownTimer);
        // If we are not ready yet, keep a calm message
        countdownEl.textContent = 'YÃ¶n belirleniyorâ€¦';
        return;
      }
      countdownEl.textContent = `YÃ¶n belirleniyorâ€¦ ${countdownValue}`;
    }, 1000);
  }

  function hideCountdown(){
    clearInterval(countdownTimer);
    countdownEl.classList.remove('show');
  }

  function bearingToKaaba(lat, lon) {
    const Ï†1 = lat * Math.PI/180, Î»1 = lon * Math.PI/180;
    const y = Math.sin(KAABA.lon - Î»1) * Math.cos(KAABA.lat);
    const x = Math.cos(Ï†1)*Math.sin(KAABA.lat) - Math.sin(Ï†1)*Math.cos(KAABA.lat)*Math.cos(KAABA.lon - Î»1);
    let Î¸ = Math.atan2(y, x) * 180/Math.PI;
    return (Î¸ + 360) % 360;
  }

  function requestLocation() {
    warn.textContent = 'Konum isteniyor...';
    setState('Konumâ€¦');
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        qiblaBearing = bearingToKaaba(pos.coords.latitude, pos.coords.longitude);
        bearingTxt.textContent = `KÄ±ble: ${Math.round(qiblaBearing)}Â°`;
        warn.textContent = compassStarted ? '' : 'Åžimdi â€œBaÅŸlat (SensÃ¶r Ä°zni)â€ butonuna bas.';
        setState(compassStarted ? 'HazÄ±r âœ…' : 'Konum hazÄ±r âœ…', true);

        // If compass already started, we can show countdown to reassure
        if (compassStarted) showCountdown();
      },
      () => {
        warn.textContent = 'Konum izni verin. (iPhone: Ayarlar > Gizlilik ve GÃ¼venlik > Konum Servisleri)';
        setState('Konum yok');
      },
      { enableHighAccuracy:true, timeout:10000 }
    );
  }

  // Smooth rotation
  let smooth = 0;
  function setRotation(deg) {
    smooth = smooth + 0.18 * (deg - smooth);
    rot.style.transform = `translate(-50%,-50%) rotate(${smooth}deg)`;
  }

  // When we first get a reliable heading, we stop countdown
  let gotFirstHeading = false;

  function handleOrientation(e) {
    if (qiblaBearing == null) return;

    let heading = null;
    if (typeof e.webkitCompassHeading === 'number') heading = e.webkitCompassHeading;
    else if (typeof e.alpha === 'number') heading = 360 - e.alpha;

    if (heading == null) return;

    const rotateDeg = (qiblaBearing - heading + 360) % 360;
    setRotation(rotateDeg);

    if (!gotFirstHeading){
      gotFirstHeading = true;
      hideCountdown();
      setState('Ã‡alÄ±ÅŸÄ±yor âœ…', true);
      warn.textContent = '';
    }
  }

  async function startCompass() {
    gotFirstHeading = false;
    compassStarted = false;
    setState('Ä°zinâ€¦');

    // Start countdown immediately to reassure user
    showCountdown();

    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const p = await DeviceOrientationEvent.requestPermission();
        if (p !== 'granted') {
          hideCountdown();
          warn.textContent = 'Pusula izni verilmedi. iPhone: Ayarlar > Safari > Hareket ve YÃ¶n EriÅŸimi aÃ§Ä±k olmalÄ±.';
          setState('Ä°zin yok');
          return;
        }
      } catch {
        hideCountdown();
        warn.textContent = 'Pusula izni alÄ±namadÄ±. Safari sensÃ¶r eriÅŸimi kapalÄ± olabilir.';
        setState('Ä°zin yok');
        return;
      }
    }

    window.addEventListener('deviceorientation', handleOrientation, true);
    compassStarted = true;

    startBtn.disabled = true;
    startBtn.textContent = 'SensÃ¶r AÃ§Ä±k âœ…';

    // if location not ready, keep a friendly message
    warn.textContent = (qiblaBearing == null)
      ? 'Konum izni gerekli. LÃ¼tfen konum izni ver.'
      : 'YÃ¶n belirleniyorâ€¦';

    setState('BaÅŸlatÄ±ldÄ±â€¦');
  }

  startBtn.addEventListener('click', startCompass);
  requestLocation();
</script>
</body>
</html>
