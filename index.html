<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KÄ±ble Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    #top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 12px; border:1px solid #ccc; border-radius:10px; background:#fff; cursor:pointer; }
    button:hover { background:#f5f5f5; }
    #status { margin:10px 0; font-size:14px; }
    #map { width:100%; height:70vh; border-radius:14px; overflow:hidden; border:1px solid #e5e5e5; }
    .ok { color: #0a7a2f; }
    .bad { color: #b00020; }
    .info { color:#333; }
  </style>
</head>
<body>
  <h1>ğŸ§­ KÄ±ble Test</h1>

  <div id="top">
    <button id="btnLoc">ğŸ“ Konum al</button>
    <button id="btnSide">ğŸ§­ Side</button>
    <button id="btnClear">ğŸ§¹ Temizle</button>
  </div>

  <div id="status" class="info">HazÄ±râ€¦</div>
  <div id="map"></div>

  <script>
    // === 1) API KEY'ini buraya koy ===
    const API_KEY = AIzaSyDjjTLQSqrvhjuG6N22cP7MiOdnvYZiSUQ;

    // === 2) KÃ¢be koordinatÄ± ===
    const KAABA = { lat: 21.422487, lng: 39.826206 };

    let map, userMarker, kaabaMarker, qiblaLine;

    function setStatus(msg, ok=true){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = ok ? "ok" : "bad";
    }

    // Bearing: kullanÄ±cÄ±dan KÃ¢be'ye giden yÃ¶n aÃ§Ä±sÄ± (0=Kuzey, 90=DoÄŸu)
    function bearingDeg(from, to){
      const Ï†1 = from.lat * Math.PI/180;
      const Ï†2 = to.lat   * Math.PI/180;
      const Î”Î» = (to.lng - from.lng) * Math.PI/180;

      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      let Î¸ = Math.atan2(y, x) * 180/Math.PI;
      Î¸ = (Î¸ + 360) % 360;
      return Î¸;
    }

    function degToCardinal(deg){
      const dirs = ["K", "KKD", "KD", "DKD", "D", "DGD", "GD", "GGD", "G", "GGB", "GB", "BGB", "B", "BKB", "KB", "KKB"];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function initMap(){
      if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
        setStatus("âŒ API key boÅŸ. YOUR_API_KEY_HERE yazan yere kendi keyâ€™ini yapÄ±ÅŸtÄ±r.", false);
        return;
      }

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.766, lng: 31.389 }, // Side civarÄ± baÅŸlangÄ±Ã§
        zoom: 12,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
      });

      // KÃ¢be marker (haritada hep dursun istersen kapatabiliriz)
      kaabaMarker = new google.maps.Marker({
        position: KAABA,
        map,
        title: "KÃ¢be (Mekke)",
      });

      setStatus("âœ… Harita yÃ¼klendi. Åimdi 'Konum al' bas.", true);
    }

    function drawQiblaFromUser(userPos){
      // kullanÄ±cÄ± marker
      if (userMarker) userMarker.setMap(null);
      userMarker = new google.maps.Marker({
        position: userPos,
        map,
        title: "Senin konumun",
      });

      // kÄ±ble Ã§izgisi
      if (qiblaLine) qiblaLine.setMap(null);
      qiblaLine = new google.maps.Polyline({
        path: [userPos, KAABA],
        map,
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 3,
      });

      // hesap
      const deg = bearingDeg(userPos, KAABA);
      const card = degToCardinal(deg);

      setStatus(`ğŸ§­ KÄ±ble yÃ¶nÃ¼: ${deg.toFixed(1)}Â° (${card}) â€” Ã§izgi KÃ¢beâ€™ye gidiyor.`, true);

      // kullanÄ±cÄ±yÄ± biraz zoomla gÃ¶ster
      map.setCenter(userPos);
      map.setZoom(15);
    }

    document.getElementById("btnLoc").addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus("âŒ TarayÄ±cÄ± konum desteklemiyor.", false);
        return;
      }
      setStatus("ğŸ“¡ Konum alÄ±nÄ±yorâ€¦ (izin ver)", true);

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          drawQiblaFromUser(userPos);
        },
        (err) => {
          setStatus("âŒ Konum alÄ±namadÄ±. iPhoneâ€™da Safari > Ayarlar > Konum: Ä°zin ver. Hata: " + err.message, false);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    document.getElementById("btnSide").addEventListener("click", () => {
      // Side demo: sadece haritayÄ± Side'a getirir (kÄ±ble hesaplamasÄ± konumla olur)
      const side = { lat: 36.766, lng: 31.389 };
      map.setCenter(side);
      map.setZoom(14);
      setStatus("â„¹ï¸ Side'e gittik. KÄ±ble iÃ§in 'Konum al' bas.", true);
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      if (userMarker) userMarker.setMap(null);
      if (qiblaLine) qiblaLine.setMap(null);
      setStatus("Temizlendi. 'Konum al' bas.", true);
    });

    // Google Maps scriptini dinamik ekle
    (function loadMaps(){
      if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") return; // initMap zaten uyaracak
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
