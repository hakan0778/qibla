<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Qibla</title>

<style>
body{
  margin:0;
  background:#050608;
  color:#fff;
  font-family:system-ui;
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

.box{
  width:90%;
  max-width:420px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(214,178,94,.4);
  border-radius:20px;
  padding:16px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(214,178,94,.5);
  background:linear-gradient(180deg,#d6b25e,#8b6a1f);
  color:#000;
  font-weight:900;
  font-size:16px;
  margin-bottom:14px;
}

#counter{
  font-size:26px;
  font-weight:900;
  color:#ffdd8a;
  margin:12px 0;
  display:none;
}

#status{
  margin-top:10px;
  color:#aaa;
  font-size:14px;
}

.ring{
  margin-top:20px;
  width:280px;
  height:280px;
  border-radius:50%;
  border:2px solid #d6b25e;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}

.arrow{
  width:8px;
  height:120px;
  background:#ffdd8a;
  border-radius:10px;
  transform-origin:50% 90%;
  position:absolute;
}

.kaba{
  position:absolute;
  top:10px;
  font-size:24px;
}
</style>
</head>

<body>

<div class="box">
  <div><b>SÃ¼rÃ¼m: SAYAÃ‡-TEST</b></div>
  <br>

  <button class="btn" id="startBtn">BaÅŸlat (SensÃ¶r Ä°zni)</button>

  <div id="counter">YÃ¶n bulunuyor: 5</div>

  <div class="ring">
    <div class="kaba">ðŸ•‹</div>
    <div id="arrow" class="arrow"></div>
  </div>

  <div id="status">HazÄ±r</div>
</div>

<script>
const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 };
const counter = document.getElementById("counter");
const statusTxt = document.getElementById("status");
const arrow = document.getElementById("arrow");
const startBtn = document.getElementById("startBtn");

let qibla = null;
let smooth = 0;

function bearingToKaaba(lat, lon) {
  const Ï†1 = lat * Math.PI/180, Î»1 = lon * Math.PI/180;
  const y = Math.sin(KAABA.lon - Î»1) * Math.cos(KAABA.lat);
  const x = Math.cos(Ï†1)*Math.sin(KAABA.lat) - Math.sin(Ï†1)*Math.cos(KAABA.lat)*Math.cos(KAABA.lon - Î»1);
  let Î¸ = Math.atan2(y, x) * 180/Math.PI;
  return (Î¸ + 360) % 360;
}

function startCountdown(){
  let t = 5;
  counter.style.display="block";
  counter.textContent = "YÃ¶n bulunuyor: " + t;

  const timer = setInterval(()=>{
    t--;
    counter.textContent = "YÃ¶n bulunuyor: " + t;
    if(t<=0){
      clearInterval(timer);
      counter.textContent = "HazÄ±r âœ…";
      setTimeout(()=>counter.style.display="none",1500);
    }
  },1000);
}

function rotate(deg){
  smooth += 0.2*(deg-smooth);
  arrow.style.transform = `rotate(${smooth}deg)`;
}

function handleOri(e){
  if(qibla==null) return;

  let heading = null;
  if(typeof e.webkitCompassHeading==="number") heading=e.webkitCompassHeading;
  else if(typeof e.alpha==="number") heading=360-e.alpha;

  if(!heading) return;

  const r = (qibla-heading+360)%360;
  rotate(r);
}

async function start(){
  startBtn.disabled=true;
  startCountdown();
  statusTxt.textContent="Konum alÄ±nÄ±yor...";

  navigator.geolocation.getCurrentPosition(pos=>{
    qibla = bearingToKaaba(pos.coords.latitude,pos.coords.longitude);
    statusTxt.textContent="Pusula Ã§alÄ±ÅŸÄ±yor";

    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().then(p=>{
        if(p==="granted"){
          window.addEventListener("deviceorientation",handleOri,true);
        }
      });
    } else {
      window.addEventListener("deviceorientation",handleOri,true);
    }
  });
}

startBtn.addEventListener("click",start);
</script>

</body>
</html>
