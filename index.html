<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Qibla Compass</title>
  <style>
    :root { --bg:#0b1220; --card:#111b30; --text:#e9eefc; --muted:#a9b6d3; --accent:#60a5fa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    header { padding: 14px 14px 10px; }
    h1 { margin:0; font-size: 18px; letter-spacing:.3px; }
    .muted { color: var(--muted); font-size: 13px; margin-top: 4px; line-height: 1.35; }
    .wrap { padding: 0 14px 14px; display: grid; gap: 12px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 16px; padding: 12px; }
    #map { width: 100%; height: 46vh; border-radius: 14px; overflow:hidden; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    button {
      appearance:none; border:0; border-radius: 12px; padding: 10px 12px;
      background: var(--accent); color: #06111f; font-weight: 700; cursor:pointer;
    }
    button.secondary { background: rgba(255,255,255,.10); color: var(--text); font-weight: 600; }
    .pill { padding: 8px 10px; border-radius: 999px; background: rgba(255,255,255,.08); font-size: 13px; }
    .big { font-size: 22px; font-weight: 800; }
    .arrowBox { display:flex; align-items:center; gap: 12px; }
    .arrow {
      width: 64px; height: 64px; border-radius: 16px;
      background: rgba(255,255,255,.08);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.07);
    }
    .arrow svg { width: 44px; height: 44px; transform-origin: 50% 50%; }
    .status { font-size: 13px; color: var(--muted); line-height: 1.35; }
    .warn { color: #ffd08a; }
    code { background: rgba(0,0,0,.25); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <header>
    <h1>ğŸ§­ Qibla Compass</h1>
    <div class="muted">
      Harita + KÄ±ble yÃ¶nÃ¼. iPhoneâ€™da pusula iÃ§in butona basÄ±p izin ver.
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="arrowBox">
          <div class="arrow" aria-label="Qibla Arrow">
            <svg id="arrowSvg" viewBox="0 0 24 24" fill="none">
              <path d="M12 2l6 10-6-2-6 2 6-10z" fill="white" opacity=".95"/>
              <path d="M12 10v12" stroke="white" stroke-width="2" stroke-linecap="round" opacity=".9"/>
            </svg>
          </div>
          <div>
            <div class="big" id="qiblaDeg">--Â°</div>
            <div class="status">KÄ±ble aÃ§Ä±sÄ± (kuzeye gÃ¶re)</div>
          </div>
        </div>

        <div class="row">
          <button id="btnLocate">Konum Al</button>
          <button id="btnCompass" class="secondary">PusulayÄ± AÃ§ (iPhone)</button>
        </div>
      </div>

      <div style="margin-top:10px;" class="row">
        <div class="pill" id="latlng">ğŸ“ Konum: --</div>
        <div class="pill" id="heading">ğŸ§­ Telefon yÃ¶nÃ¼: --</div>
        <div class="pill" id="err" style="display:none;">âš ï¸</div>
      </div>

      <div class="status" style="margin-top:10px;">
        Not: Harita gÃ¶rÃ¼nmÃ¼yorsa en sÄ±k sebep <span class="warn">HTTP referrer kÄ±sÄ±tÄ±</span> ve site adresinin eÅŸleÅŸmemesi.
      </div>
    </div>

    <div class="card">
      <div id="map"></div>
    </div>
  </div>

  <script>
    // âœ… SADECE BURAYA API KEYâ€™Ä°NÄ° YAPIÅTIR
    const API_KEY = "YOUR_API_KEY_HERE";

    // Kaabe koordinatÄ±
    const KAABA = { lat: 21.422487, lng: 39.826206 };

    // Google Maps objeleri
    let map, userMarker, kaabaMarker, qiblaLine;
    let userPos = null;

    // Pusula state
    let deviceHeading = null; // 0..360 (kuzey=0)
    let qiblaBearing = null;  // 0..360 (kuzey=0)

    function setErr(msg) {
      const el = document.getElementById("err");
      if (!msg) { el.style.display="none"; el.textContent=""; return; }
      el.style.display="inline-block";
      el.textContent = "âš ï¸ " + msg;
      el.classList.add("warn");
    }

    // Bearing (kuzeye gÃ¶re) hesapla: kullanÄ±cÄ± -> Kaabe
    function bearingDeg(from, to) {
      const Ï†1 = from.lat * Math.PI/180;
      const Ï†2 = to.lat   * Math.PI/180;
      const Î”Î» = (to.lng - from.lng) * Math.PI/180;

      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      let Î¸ = Math.atan2(y, x) * 180/Math.PI;
      Î¸ = (Î¸ + 360) % 360;
      return Î¸;
    }

    function updateUI() {
      // Qibla text
      document.getElementById("qiblaDeg").textContent =
        qiblaBearing == null ? "--Â°" : `${Math.round(qiblaBearing)}Â°`;

      // LatLng pill
      document.getElementById("latlng").textContent =
        userPos ? `ğŸ“ Konum: ${userPos.lat.toFixed(6)}, ${userPos.lng.toFixed(6)}` : "ğŸ“ Konum: --";

      // Heading pill
      document.getElementById("heading").textContent =
        deviceHeading == null ? "ğŸ§­ Telefon yÃ¶nÃ¼: --" : `ğŸ§­ Telefon yÃ¶nÃ¼: ${Math.round(deviceHeading)}Â°`;

      // Arrow rotate:
      // Ekrandaki okun "Kaabe yÃ¶nÃ¼nÃ¼" gÃ¶stermesi iÃ§in:
      // ok = (qiblaBearing - deviceHeading)
      const arrow = document.getElementById("arrowSvg");
      if (qiblaBearing == null) {
        arrow.style.transform = "rotate(0deg)";
      } else {
        const rel = deviceHeading == null ? qiblaBearing : (qiblaBearing - deviceHeading + 360) % 360;
        arrow.style.transform = `rotate(${rel}deg)`;
      }
    }

    function drawOnMap() {
      if (!map || !userPos) return;

      // Markerlar
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          map,
          position: userPos,
          title: "Senin konumun"
        });
      } else {
        userMarker.setPosition(userPos);
      }

      if (!kaabaMarker) {
        kaabaMarker = new google.maps.Marker({
          map,
          position: KAABA,
          title: "KÃ¢be (Mekke)"
        });
      }

      // Ã‡izgi
      const path = [userPos, KAABA];
      if (!qiblaLine) {
        qiblaLine = new google.maps.Polyline({
          map,
          path,
          geodesic: true,
          strokeOpacity: 0.9,
          strokeWeight: 3
        });
      } else {
        qiblaLine.setPath(path);
      }

      // Map center
      map.panTo(userPos);
    }

    // Konum al
    async function locate() {
      setErr("");
      if (!navigator.geolocation) {
        setErr("TarayÄ±cÄ± konumu desteklemiyor.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          qiblaBearing = bearingDeg(userPos, KAABA);
          if (map) drawOnMap();
          updateUI();
        },
        (err) => {
          setErr("Konum izni verilmedi veya alÄ±namadÄ±. iPhone: Ayarlar > Safari > Konum.");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // iOS pusula izni
    async function enableCompass() {
      setErr("");
      try {
        // iOS 13+ permission flow
        if (typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function") {
          const resp = await DeviceOrientationEvent.requestPermission();
          if (resp !== "granted") {
            setErr("Pusula izni verilmedi (Motion & Orientation).");
            return;
          }
        }

        window.addEventListener("deviceorientation", (e) => {
          // iOS Safari: webkitCompassHeading (0..360, kuzey=0)
          if (typeof e.webkitCompassHeading === "number") {
            deviceHeading = e.webkitCompassHeading;
          } else if (typeof e.alpha === "number") {
            // Android/diÄŸer: alpha genelde pusula deÄŸil ama yine de gÃ¶sterelim
            deviceHeading = (360 - e.alpha) % 360;
          }
          updateUI();
        }, true);

        setErr("Pusula aktif âœ… Telefonu dÃ¼z tut, biraz hareket ettir.");
      } catch {
        setErr("Pusula aÃ§Ä±lamadÄ±. iPhone: Ayarlar > Safari > Motion & Orientation Access.");
      }
    }

    // Google Maps init (callback)
    window.initMap = function () {
      // Default center: Mekke (konum gelene kadar)
      map = new google.maps.Map(document.getElementById("map"), {
        center: KAABA,
        zoom: 4,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      kaabaMarker = new google.maps.Marker({
        map,
        position: KAABA,
        title: "KÃ¢be (Mekke)"
      });

      updateUI();
    };

    // UI hooks
    document.getElementById("btnLocate").addEventListener("click", locate);
    document.getElementById("btnCompass").addEventListener("click", enableCompass);

    // Load Maps JS (dinamik)
    (function loadMaps() {
      if (!API_KEY || API_KEY.includes(AIzaSyDjjTLQSqrvhjuG6N22cP7MiOdnvYZiSUQ)) {
        setErr("API key eklemen lazÄ±m. index.html iÃ§inde API_KEY alanÄ±na yapÄ±ÅŸtÄ±r.");
        return;
      }
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      s.async = true;
      s.defer = true;
      s.onerror = () => setErr("Google Maps script yÃ¼klenmedi. (Key/Referrer/Billing/API enable kontrol)");
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
