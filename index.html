<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kƒ±ble | iOS Pusula Fix</title>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    #panel{
      position: fixed; left: 12px; top: 12px; z-index: 10;
      background: rgba(255,255,255,.95); padding: 10px 12px;
      border-radius: 12px; font-family: system-ui, Arial; font-size: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      max-width: 390px;
    }
    #status { margin-top: 8px; font-size: 12px; opacity: .95; white-space: pre-line; line-height: 1.35; }
    .row { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      padding: 9px 10px; border: 0; border-radius: 10px; cursor: pointer;
      background:#111; color:#fff; font-weight:700;
    }
    button.secondary { background:#e9e9e9; color:#111; font-weight:700; }

    #startOverlay{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.55);
      display: flex;
      align-items: center; justify-content: center;
      padding: 20px;
    }
    #startCard{
      width: min(440px, 92vw);
      background: #fff; border-radius: 16px;
      padding: 16px;
      font-family: system-ui, Arial;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    #startCard h3{ margin: 0 0 8px; font-size: 16px; }
    #startCard p{ margin: 0 0 12px; font-size: 13px; opacity: .85; line-height:1.35; }
    #btnStart{ width:100%; padding: 12px; border-radius: 12px; }
  </style>
</head>

<body>
  <div id="panel">
    <div><b>Kƒ±ble</b> (Konum ‚Üí K√¢be)</div>

    <div class="row">
      <button id="btnMyLoc" class="secondary">üìç Konumuma Git</button>
      <button id="btnToggle" class="secondary">üõ∞ Uydu / Harita</button>
    </div>

    <div id="status">Harita y√ºkleniyor‚Ä¶</div>
  </div>

  <div id="map"></div>

  <div id="startOverlay">
    <div id="startCard">
      <h3>K√¢be‚Äôyi Bul</h3>
      <p>
        ‚ÄúStart‚Äù ile iPhone pusula izni sorar. ƒ∞zin verince,
        telefonu √ßevir. Telefonun √ºst√º kƒ±bleye gelince √ßizgi ye≈üil olur.
        <br><br>
        Not: Bu s√ºr√ºmde pusula verisi gelmezse ekranda a√ßƒ±k√ßa yazar.
      </p>
      <button id="btnStart">K√¢be‚Äôyi Bul (Start)</button>
    </div>
  </div>

  <script>
    /************ AYARLAR ************/
    const KAABA = { lat: 21.422487, lng: 39.826206 };
    const CLOSE_ZOOM = 17;
    const ALIGN_TOL_DEG = 7;
    const LINE_RED = "#111";
    const LINE_GREEN = "#19a84a";

    /************ DURUM ************/
    let map, kaabaMarker, userMarker, qiblaLine;
    let mapIsSatellite = true;

    let userPos = null;
    let qiblaDeg = null;

    let haveMotion = false;
    let headingDeg = null; // 0..360
    let lastEventTs = 0;

    function setStatus(t){
      const el = document.getElementById("status");
      if (el) el.textContent = t;
    }
    function showStartOverlay(show){
      const el = document.getElementById("startOverlay");
      if (el) el.style.display = show ? "flex" : "none";
    }

    function normalize360(x){ return (x % 360 + 360) % 360; }
    function toRad(d){ return d * Math.PI / 180; }
    function toDeg(r){ return r * 180 / Math.PI; }
    function angleDelta(a, b){
      let d = normalize360(a - b);
      if (d > 180) d = 360 - d;
      return d;
    }

    function bearingToKaaba(lat, lng){
      const œÜ1 = toRad(lat);
      const œÜ2 = toRad(KAABA.lat);
      const ŒîŒª = toRad(KAABA.lng - lng);
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      const Œ∏ = Math.atan2(y, x);
      return (toDeg(Œ∏) + 360) % 360;
    }

    /************ KONUM ************/
    function getLocationOnce(){
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation desteklenmiyor."));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    async function startLocation(){
      setStatus("Konum alƒ±nƒ±yor...");
      userPos = await getLocationOnce();
      qiblaDeg = bearingToKaaba(userPos.lat, userPos.lng);

      ensureUserMarker();
      ensureLine();
      zoomToUser();
      updateLineColorAndDebug();
    }

    /************ HARƒ∞TA ************/
    function ensureUserMarker(){
      if (!userPos) return;
      if (!userMarker) userMarker = new google.maps.Marker({ position: userPos, map, title: "Konumum" });
      else userMarker.setPosition(userPos);
    }

    function ensureLine(){
      if (!userPos) return;
      if (qiblaLine) qiblaLine.setMap(null);
      qiblaLine = new google.maps.Polyline({
        path: [userPos, KAABA],
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 5,
        strokeColor: LINE_RED
      });
      qiblaLine.setMap(map);
    }

    function zoomToUser(){
      if (!userPos || !map) return;
      map.setCenter(userPos);
      map.setZoom(CLOSE_ZOOM);
    }

    function updateLineColorAndDebug(extraText=""){
      if (!qiblaLine || qiblaDeg == null || !userPos) return;

      let ok = false;
      if (haveMotion && headingDeg != null) {
        const d = angleDelta(qiblaDeg, headingDeg);
        ok = d <= ALIGN_TOL_DEG;
      }
      qiblaLine.setOptions({ strokeColor: ok ? LINE_GREEN : LINE_RED });

      const parts = [];
      parts.push(`Konum: ${userPos.lat.toFixed(5)}, ${userPos.lng.toFixed(5)}`);
      parts.push(`Kƒ±ble: ${qiblaDeg.toFixed(1)}¬∞`);

      if (haveMotion) {
        if (headingDeg != null) {
          const d = angleDelta(qiblaDeg, headingDeg);
          parts.push(`Pusula: ${headingDeg.toFixed(1)}¬∞`);
          parts.push(`Fark: ${d.toFixed(1)}¬∞ (‚â§ ${ALIGN_TOL_DEG}¬∞ olunca YE≈ûƒ∞L)`);
        } else {
          parts.push(`Pusula: izin var ama veri gelmiyor (sens√∂r kapalƒ± olabilir)`);
        }
      } else {
        parts.push(`Pusula: Kapalƒ± (Start'a bas)`);
      }

      if (extraText) parts.push(extraText);
      setStatus(parts.join("\n"));
    }

    /************ iOS PUSULA: HESAPLI HEADING (fallback) ************/
    // alpha/beta/gamma'dan heading hesaplama (webkitCompassHeading yoksa)
    function compassHeadingFromEuler(alpha, beta, gamma) {
      // kaynak form√ºl: cihaz orientation'dan d√ºnya koordinatƒ±na d√∂n√º≈ü√ºm mantƒ±ƒüƒ±
      const _alpha = toRad(alpha);
      const _beta  = toRad(beta);
      const _gamma = toRad(gamma);

      const cA = Math.cos(_alpha), sA = Math.sin(_alpha);
      const cB = Math.cos(_beta),  sB = Math.sin(_beta);
      const cG = Math.cos(_gamma), sG = Math.sin(_gamma);

      // rotation matrix (Z-X'-Y'')
      const rA = -cA * sG - sA * sB * cG;
      const rB = -sA * sG + cA * sB * cG;

      let heading = Math.atan2(rA, rB);
      heading = toDeg(heading);
      return normalize360(heading);
    }

    /************ Y√ñN (PUSULA) ************/
    async function enableCompassWithPermission(){
      // iOS: user gesture ile izin ister
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") throw new Error("Y√∂n izni verilmedi.");
      }
      haveMotion = true;

      window.addEventListener("deviceorientationabsolute", onOrientation, true);
      window.addEventListener("deviceorientation", onOrientation, true);

      // 1 saniye sonra sens√∂r verisi gelmi≈ü mi kontrol et
      setTimeout(() => {
        const now = Date.now();
        if (!lastEventTs || (now - lastEventTs) > 900) {
          updateLineColorAndDebug(
            "‚ö†Ô∏è iPhone sens√∂r verisi gelmedi.\n" +
            "Ayarlar ‚Üí Safari ‚Üí Motion & Orientation Access: A√áIK olmalƒ±.\n" +
            "Ayrƒ±ca Telefonu 8 √ßizip pusulayƒ± kalibre etmeyi dene."
          );
        }
      }, 1200);
    }

    function onOrientation(e){
      lastEventTs = Date.now();

      // 1) iOS ger√ßek pusula (varsa en iyi)
      if (typeof e.webkitCompassHeading === "number") {
        headingDeg = normalize360(e.webkitCompassHeading);
        updateLineColorAndDebug("Kaynak: webkitCompassHeading ‚úÖ");
        return;
      }

      // 2) Fallback: alpha/beta/gamma‚Äôdan hesapla
      if (typeof e.alpha === "number" && typeof e.beta === "number" && typeof e.gamma === "number") {
        headingDeg = compassHeadingFromEuler(e.alpha, e.beta, e.gamma);
        updateLineColorAndDebug("Kaynak: hesaplanan heading (alpha/beta/gamma) ‚úÖ");
        return;
      }

      // 3) Olmadƒ±: veri yok
      headingDeg = null;
      updateLineColorAndDebug("Kaynak: sens√∂r verisi yok ‚ùå");
    }

    /************ START ************/
    async function onStart(){
      showStartOverlay(false);

      // 1) Konum
      try {
        await startLocation();
      } catch (e) {
        setStatus("Konum alƒ±namadƒ±: " + (e.message || "Hata"));
        showStartOverlay(true);
        return;
      }

      // 2) Pusula
      try {
        await enableCompassWithPermission();
        updateLineColorAndDebug("Pusula a√ßƒ±ldƒ±. Telefonu √ßevir‚Ä¶");
      } catch (e) {
        haveMotion = false;
        updateLineColorAndDebug("‚ùå Y√∂n izni verilmedi ‚Üí ye≈üile d√∂nmez.");
      }
    }

    /************ MAP INIT ************/
    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.8, lng: 31.4 },
        zoom: 6,
        mapTypeId: "satellite",
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
      });

      kaabaMarker = new google.maps.Marker({ position: KAABA, map, title: "K√¢be" });
      setStatus("Harita hazƒ±r. Start ile pusulayƒ± a√ß.");
    }
    window.initMap = initMap;

    /************ UI ************/
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnStart").addEventListener("click", onStart);

      document.getElementById("btnToggle").addEventListener("click", () => {
        if (!map) return;
        mapIsSatellite = !mapIsSatellite;
        map.setMapTypeId(mapIsSatellite ? "satellite" : "roadmap");
      });

      document.getElementById("btnMyLoc").addEventListener("click", () => {
        zoomToUser();
      });
    });
  </script>

  <!-- ‚úÖ API KEY SADECE BURADA -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjjTLQSqrvhjuG6N22cP7MiOdnvYZiSUQ&callback=initMap"
    async defer></script>
</body>
</html>
