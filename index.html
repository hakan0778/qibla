<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kıble Çizgisi (Konum → Kâbe)</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    #panel{
      position: fixed; left: 12px; top: 12px; z-index: 10;
      background: rgba(255,255,255,.95); padding: 10px 12px;
      border-radius: 10px; font-family: system-ui, Arial; font-size: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      max-width: 320px;
    }
    #status { margin-top: 6px; font-size: 12px; opacity: .85; }
    button { padding: 8px 10px; border: 0; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="panel">
    <div><b>Kıble Çizgisi</b> (Konum → Kâbe)</div>
    <div style="margin-top:8px;">
      <button id="btnLocate">Konumu Al & Çiz</button>
    </div>
    <div id="status">Hazır.</div>
  </div>

  <div id="map"></div>

  <script>
    // 1) Kâbe koordinatı (sabit)
    const KAABA = { lat: 21.422487, lng: 39.826206 };

    // 2) Harita ve objeler
    let map, userMarker, kaabaMarker, qiblaLine;

    function setStatus(t){ document.getElementById("status").textContent = t; }

    // Google Maps callback
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: KAABA,
        zoom: 4,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
      });

      // Kâbe marker
      kaabaMarker = new google.maps.Marker({
        position: KAABA,
        map,
        title: "Kâbe",
      });

      setStatus("Harita hazır. 'Konumu Al & Çiz' butonuna bas.");
    }

    // 3) Konumu al
    async function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation desteklenmiyor."));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // 4) Çizgi çiz (Konum → Kâbe)
    function drawLine(userPos) {
      // Kullanıcı marker
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          position: userPos,
          map,
          title: "Senin Konumun",
        });
      } else {
        userMarker.setPosition(userPos);
      }

      // Önceki çizgiyi kaldır
      if (qiblaLine) qiblaLine.setMap(null);

      // Çizgi (Polyline)
      qiblaLine = new google.maps.Polyline({
        path: [userPos, KAABA],
        geodesic: true,          // ✅ Kıble doğrusu için önerilen
        strokeOpacity: 1.0,
        strokeWeight: 4,
      });
      qiblaLine.setMap(map);

      // Haritayı çizgiye sığdır
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(userPos);
      bounds.extend(KAABA);
      map.fitBounds(bounds);

      setStatus(`Çizildi ✅ Konum: ${userPos.lat.toFixed(5)}, ${userPos.lng.toFixed(5)}`);
    }

    // 5) Buton: konumu al ve çiz
    document.getElementById("btnLocate").addEventListener("click", async () => {
      try {
        setStatus("Konum alınıyor...");
        const userPos = await getLocation();
        drawLine(userPos);
      } catch (e) {
        setStatus("Hata: " + (e.message || "Konum alınamadı."));
      }
    });

    // initMap'i global yap
    window.initMap = initMap;
  </script>

  <!-- 6) BURAYA API KEYİ YAPIŞTIR -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjjTLQSqrvhjuG6N22cP7MiOdnvYZiSUQ&callback=initMap"
    async defer></script>
</body>
</html>
