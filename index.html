<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Qibla</title>
  <style>
    :root{
      --bg:#07090f;
      --card:#0e1324;
      --line:rgba(255,255,255,.10);
      --accent:#ff7a18;
      --blue:#3b82f6;
      --warn:#ffcc66;
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.75);
    }

    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body { overflow:hidden; }

    /* Safe-area padding for iPhone notch */
    .app {
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(12px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      gap:12px;
      max-width:520px;
      margin:0 auto;
    }

    .top {
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row { display:flex; gap:10px; align-items:center; }
    .btn{
      flex:1;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      background:var(--blue);
      color:white;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .chip{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-weight:700;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .hint{ font-size:12.5px; color:var(--muted); line-height:1.35; }

    .mid{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:0;
    }

    .ring {
      width:min(320px, 82vw);
      aspect-ratio:1/1;
      border:2px solid rgba(168,90,26,.85);
      border-radius:50%;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 30%, rgba(255,122,24,.18), rgba(255,255,255,.02) 45%, rgba(0,0,0,.35));
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }

    .label { position:absolute; opacity:.75; font-weight:800; font-size:14px; letter-spacing:.5px; }
    .n { top:10px; color:var(--accent); opacity:1; }
    .e { right:14px; }
    .s { bottom:10px; }
    .w { left:14px; }

    .center { width:8px; height:8px; background:var(--accent); border-radius:50%; position:absolute; box-shadow:0 0 18px rgba(255,122,24,.55); }

    .arrow {
      width:7px;
      height:126px;
      background:var(--accent);
      border-radius:10px;
      transform-origin:50% 90%;
      transition:transform .16s ease-out;
      box-shadow:0 10px 18px rgba(0,0,0,.35);
    }

    .kaaba {
      position:absolute;
      transform:translateY(-138px);
      font-size:20px;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.45));
    }

    .bottom{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .txt { font-size:14px; }
    .warn { color:var(--warn); font-size:13px; line-height:1.35; }
    .ok { color:#86efac; }
  </style>
</head>
<body>
  <div class="app">

    <div class="top">
      <div class="row">
        <button id="startBtn" class="btn">BaÅŸlat (SensÃ¶r Ä°zni)</button>
        <div id="stateChip" class="chip">Bekliyorâ€¦</div>
      </div>
      <div class="hint">
        iPhoneâ€™da pusula sensÃ¶rÃ¼ sadece <b>butona bastÄ±ktan sonra</b> aÃ§Ä±lÄ±r. (Apple kuralÄ±)
      </div>
    </div>

    <div class="mid">
      <div class="ring">
        <div class="label n">N</div><div class="label e">E</div><div class="label s">S</div><div class="label w">W</div>
        <div class="center"></div>
        <div id="arrow" class="arrow"></div>
        <div id="kaaba" class="kaaba">ðŸ•‹</div>
      </div>
    </div>

    <div class="bottom">
      <div id="bearingTxt" class="txt">KÄ±ble: --Â°</div>
      <div id="warn" class="warn"></div>
      <div class="hint">Ä°pucu: DoÄŸru Ã¶lÃ§Ã¼m iÃ§in telefonu dÃ¼z tut, metal/pusula etkisi yapabilecek ÅŸeylerden uzak dur.</div>
    </div>

  </div>

<script>
  const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 };
  const warn = document.getElementById('warn');
  const bearingTxt = document.getElementById('bearingTxt');
  const arrow = document.getElementById('arrow');
  const kaaba = document.getElementById('kaaba');
  const startBtn = document.getElementById('startBtn');
  const stateChip = document.getElementById('stateChip');

  let qiblaBearing = null;
  let compassStarted = false;

  function setState(t, ok=false){
    stateChip.textContent = t;
    stateChip.classList.toggle('ok', ok);
  }

  function bearingToKaaba(lat, lon) {
    const Ï†1 = lat * Math.PI/180, Î»1 = lon * Math.PI/180;
    const y = Math.sin(KAABA.lon - Î»1) * Math.cos(KAABA.lat);
    const x = Math.cos(Ï†1)*Math.sin(KAABA.lat) - Math.sin(Ï†1)*Math.cos(KAABA.lat)*Math.cos(KAABA.lon - Î»1);
    let Î¸ = Math.atan2(y, x) * 180/Math.PI;
    return (Î¸ + 360) % 360;
  }

  function requestLocation() {
    warn.textContent = 'Konum isteniyor...';
    setState('Konumâ€¦');
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        qiblaBearing = bearingToKaaba(pos.coords.latitude, pos.coords.longitude);
        bearingTxt.textContent = `KÄ±ble: ${Math.round(qiblaBearing)}Â°`;
        warn.textContent = compassStarted ? '' : 'Åžimdi â€œBaÅŸlat (SensÃ¶r Ä°zni)â€ butonuna bas.';
        setState(compassStarted ? 'HazÄ±r âœ…' : 'Konum hazÄ±r âœ…', true);
      },
      () => {
        warn.textContent = 'Konum izni verin. (iPhone: Ayarlar > Gizlilik ve GÃ¼venlik > Konum Servisleri)';
        setState('Konum yok');
      },
      { enableHighAccuracy:true, timeout:10000 }
    );
  }

  // Smooth rotation
  let smooth = 0;
  function setRotation(deg) {
    smooth = smooth + 0.18 * (deg - smooth);
    arrow.style.transform = `rotate(${smooth}deg)`;
    kaaba.style.transform = `translateY(-138px) rotate(${smooth}deg)`;
  }

  function handleOrientation(e) {
    if (qiblaBearing == null) return;

    let heading = null;
    if (typeof e.webkitCompassHeading === 'number') heading = e.webkitCompassHeading;   // iOS best
    else if (typeof e.alpha === 'number') heading = 360 - e.alpha;                      // fallback

    if (heading == null) return;

    const rotateDeg = (qiblaBearing - heading + 360) % 360;
    setRotation(rotateDeg);
  }

  async function startCompass() {
    compassStarted = false;
    setState('Ä°zinâ€¦');

    // iOS permission must be requested on user gesture
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const p = await DeviceOrientationEvent.requestPermission();
        if (p !== 'granted') {
          warn.textContent = 'Pusula izni verilmedi. iPhone: Ayarlar > Safari > Hareket ve YÃ¶n EriÅŸimi aÃ§Ä±k olmalÄ±.';
          setState('Ä°zin yok');
          return;
        }
      } catch {
        warn.textContent = 'Pusula izni alÄ±namadÄ±. Safari sensÃ¶r eriÅŸimi kapalÄ± olabilir.';
        setState('Ä°zin yok');
        return;
      }
    }

    window.addEventListener('deviceorientation', handleOrientation, true);
    compassStarted = true;

    startBtn.disabled = true;
    startBtn.textContent = 'SensÃ¶r AÃ§Ä±k âœ…';
    warn.textContent = (qiblaBearing == null)
      ? 'Konum izni gerekli. LÃ¼tfen konum izni ver.'
      : '';

    setState('Ã‡alÄ±ÅŸÄ±yor âœ…', true);
  }

  startBtn.addEventListener('click', startCompass);
  requestLocation();
</script>
</body>
</html>
