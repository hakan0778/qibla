<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kƒ±ble | iPhone Pusula Te≈ühis</title>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    #panel{
      position: fixed; left: 12px; top: 12px; z-index: 10;
      background: rgba(255,255,255,.95); padding: 10px 12px;
      border-radius: 12px; font-family: system-ui, Arial; font-size: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      max-width: 410px;
    }
    #status { margin-top: 8px; font-size: 12px; opacity: .95; white-space: pre-line; line-height: 1.35; }
    .row { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      padding: 9px 10px; border: 0; border-radius: 10px; cursor: pointer;
      background:#111; color:#fff; font-weight:700;
    }
    button.secondary { background:#e9e9e9; color:#111; font-weight:700; }

    #startOverlay{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.55);
      display: flex;
      align-items: center; justify-content: center;
      padding: 20px;
    }
    #startCard{
      width: min(460px, 92vw);
      background: #fff; border-radius: 16px;
      padding: 16px;
      font-family: system-ui, Arial;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    #startCard h3{ margin: 0 0 8px; font-size: 16px; }
    #startCard p{ margin: 0 0 12px; font-size: 13px; opacity: .85; line-height:1.35; }
    #btnStart{ width:100%; padding: 12px; border-radius: 12px; }
  </style>
</head>

<body>
  <div id="panel">
    <div><b>Kƒ±ble</b> (Konum ‚Üí K√¢be)</div>

    <div class="row">
      <button id="btnMyLoc" class="secondary">üìç Konumuma Git</button>
      <button id="btnToggle" class="secondary">üõ∞ Uydu / Harita</button>
    </div>

    <div id="status">Harita y√ºkleniyor‚Ä¶</div>
  </div>

  <div id="map"></div>

  <div id="startOverlay">
    <div id="startCard">
      <h3>K√¢be‚Äôyi Bul (Start)</h3>
      <p>
        Bu s√ºr√ºm ‚Äúpusula niye √ßalƒ±≈ümƒ±yor?‚Äù te≈ühis eder:
        Start‚Äôa basƒ±nca <b>izin sonucu</b> ve <b>sens√∂r verisi geliyor mu</b> ekranda yazacak.
      </p>
      <button id="btnStart">K√¢be‚Äôyi Bul (Start)</button>
    </div>
  </div>

  <script>
    const KAABA = { lat: 21.422487, lng: 39.826206 };
    const CLOSE_ZOOM = 17;
    const ALIGN_TOL_DEG = 7;
    const LINE_RED = "#111";
    const LINE_GREEN = "#19a84a";

    let map, kaabaMarker, userMarker, qiblaLine;
    let mapIsSatellite = true;

    let userPos = null;
    let qiblaDeg = null;

    let permissionResult = "unknown";
    let lastEventTs = 0;
    let headingDeg = null;

    function setStatus(t){ document.getElementById("status").textContent = t; }
    function showStartOverlay(show){ document.getElementById("startOverlay").style.display = show ? "flex" : "none"; }
    function normalize360(x){ return (x % 360 + 360) % 360; }
    function toRad(d){ return d * Math.PI/180; }
    function toDeg(r){ return r * 180/Math.PI; }
    function angleDelta(a, b){
      let d = normalize360(a - b);
      if (d > 180) d = 360 - d;
      return d;
    }
    function bearingToKaaba(lat, lng){
      const œÜ1 = toRad(lat);
      const œÜ2 = toRad(KAABA.lat);
      const ŒîŒª = toRad(KAABA.lng - lng);
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      const Œ∏ = Math.atan2(y, x);
      return (toDeg(Œ∏) + 360) % 360;
    }

    function getLocationOnce(){
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    function ensureUserMarker(){
      if (!userPos) return;
      if (!userMarker) userMarker = new google.maps.Marker({ position: userPos, map, title: "Konumum" });
      else userMarker.setPosition(userPos);
    }
    function ensureLine(){
      if (!userPos) return;
      if (qiblaLine) qiblaLine.setMap(null);
      qiblaLine = new google.maps.Polyline({
        path: [userPos, KAABA],
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 5,
        strokeColor: LINE_RED
      });
      qiblaLine.setMap(map);
    }
    function zoomToUser(){
      if (!userPos) return;
      map.setCenter(userPos);
      map.setZoom(CLOSE_ZOOM);
    }

    function updateUI(extra=""){
      const parts = [];
      parts.push(`Konum: ${userPos ? userPos.lat.toFixed(5)+", "+userPos.lng.toFixed(5) : "yok"}`);
      parts.push(`Kƒ±ble: ${qiblaDeg != null ? qiblaDeg.toFixed(1)+"¬∞" : "yok"}`);
      parts.push(`Y√∂n izni (requestPermission): ${permissionResult}`);
      parts.push(`Sens√∂r event geldi mi: ${lastEventTs ? "EVET" : "HAYIR"}`);
      parts.push(`Heading: ${headingDeg != null ? headingDeg.toFixed(1)+"¬∞" : "yok"}`);
      if (qiblaDeg != null && headingDeg != null){
        const d = angleDelta(qiblaDeg, headingDeg);
        parts.push(`Fark: ${d.toFixed(1)}¬∞ (‚â§ ${ALIGN_TOL_DEG}¬∞ olunca YE≈ûƒ∞L)`);
      }
      if (extra) parts.push(extra);
      setStatus(parts.join("\n"));
    }

    function updateLineColor(){
      if (!qiblaLine || qiblaDeg == null) return;
      let ok = false;
      if (headingDeg != null){
        ok = angleDelta(qiblaDeg, headingDeg) <= ALIGN_TOL_DEG;
      }
      qiblaLine.setOptions({ strokeColor: ok ? LINE_GREEN : LINE_RED });
    }

    function onOrientation(e){
      lastEventTs = Date.now();

      // iOS Safari: varsa en iyisi
      if (typeof e.webkitCompassHeading === "number") {
        headingDeg = normalize360(e.webkitCompassHeading);
        updateLineColor();
        updateUI("Kaynak: webkitCompassHeading ‚úÖ");
        return;
      }

      // fallback: bazƒ± cihazlarda alpha gelir
      if (typeof e.alpha === "number") {
        headingDeg = normalize360(360 - e.alpha);
        updateLineColor();
        updateUI("Kaynak: alpha fallback ‚úÖ");
        return;
      }

      headingDeg = null;
      updateUI("Kaynak: sens√∂r datasƒ± yok ‚ùå");
    }

    async function startAll(){
      // 1) Konum
      showStartOverlay(false);
      try {
        userPos = await getLocationOnce();
        qiblaDeg = bearingToKaaba(userPos.lat, userPos.lng);
        ensureUserMarker();
        ensureLine();
        zoomToUser();
      } catch (e){
        showStartOverlay(true);
        setStatus("Konum alƒ±namadƒ±. Safari‚Äôde konum izni ver.");
        return;
      }

      // 2) Pusula izni
      try {
        if (typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function") {
          permissionResult = await DeviceOrientationEvent.requestPermission();
        } else {
          // Bazƒ± iOS s√ºr√ºmlerinde requestPermission g√∂r√ºnmez ama event yine gelir
          permissionResult = "no-requestPermission (try listen)";
        }
      } catch (e){
        permissionResult = "denied (exception)";
      }

      // 3) Dinle
      window.addEventListener("deviceorientationabsolute", onOrientation, true);
      window.addEventListener("deviceorientation", onOrientation, true);

      updateUI("Start tamam. 2 saniye telefonu √ßevir‚Ä¶");

      // 2sn sonra event gelmi≈ü mi kontrol
      setTimeout(() => {
        if (!lastEventTs) {
          updateUI(
            "‚ö†Ô∏è Sens√∂r event hi√ß gelmedi.\n" +
            "Bu durumda iPhone‚Äôda genelde Safari ‚Üí Motion & Orientation Access kapalƒ±dƒ±r\n" +
            "(Ayarlar ‚Üí Safari ‚Üí Motion & Orientation Access ‚Üí A√áIK)."
          );
        }
      }, 2000);
    }

    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.8, lng: 31.4 },
        zoom: 6,
        mapTypeId: "satellite",
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
      });
      kaabaMarker = new google.maps.Marker({ position: KAABA, map, title: "K√¢be" });
      setStatus("Harita hazƒ±r. Start‚Äôa bas.");
    }
    window.initMap = initMap;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnStart").addEventListener("click", startAll);

      document.getElementById("btnToggle").addEventListener("click", () => {
        mapIsSatellite = !mapIsSatellite;
        map.setMapTypeId(mapIsSatellite ? "satellite" : "roadmap");
      });

      document.getElementById("btnMyLoc").addEventListener("click", () => {
        zoomToUser();
      });
    });
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjjTLQSqrvhjuG6N22cP7MiOdnvYZiSUQ&callback=initMap"
    async defer></script>
</body>
</html>
